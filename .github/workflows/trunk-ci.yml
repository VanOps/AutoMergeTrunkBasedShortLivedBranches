---
name: ðŸš€ Trunk-Based CI/CD

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

# Cancela runs previos del mismo PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # FAST FEEDBACK: Lint (< 30s)
  # ============================================
  lint:
    name: ðŸ” Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    defaults:
      run:
        working-directory: ./src/app
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './src/app/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline

      - name: ðŸ” Run ESLint
        run: npm run lint

      - name: ðŸ“Š Lint Summary
        run: |
          echo "### ðŸ” Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ESLint passed" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # CORE: Tests (< 2min)
  # ============================================
  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    defaults:
      run:
        working-directory: ./src/app
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './src/app/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline

      - name: ðŸ—ï¸ Build Next.js
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: ðŸ“Š Test Summary
        run: |
          echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build passed" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # SECURITY: Quick Security Scan
  # ============================================
  security:
    name: ðŸ”’ Security
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    defaults:
      run:
        working-directory: ./src/app
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './src/app/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”’ Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: ðŸ“Š Security Summary
        run: |
          echo "### ðŸ”’ Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "âœ… npm audit completed" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # AUTO-MERGE: Enable for PRs (No Approval Required)
  # ============================================
  auto-merge:
    name: ðŸ¤– Auto-Merge
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    if: |
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: ðŸ“Š Check PR info
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "### ðŸ¤– Auto-Merge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: $PR_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: $PR_AUTHOR" >> $GITHUB_STEP_SUMMARY
          echo "- **All checks**: âœ… Passed" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”€ Enable auto-merge
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge "$PR_URL" --auto --squash --delete-branch

      - name: âœ… Success
        run: |
          echo "âœ… Auto-merge enabled!" >> $GITHUB_STEP_SUMMARY
          echo "PR will merge automatically when all checks pass" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # DEPLOY: Auto-deploy to Staging on Main
  # ============================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    
    environment: 
      name: staging
      url: https://staging.tuapp.com
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to staging
        run: |
          echo "ðŸš€ Deploying to staging..."
          echo "URL: https://staging.tuapp.com"
          # Tu lÃ³gica de deploy aquÃ­
          # Ejemplo: vercel deploy --env=staging
          # Ejemplo: aws s3 sync dist/ s3://staging-bucket

      - name: â³ Wait for deployment
        run: sleep 5

      - name: ðŸ“Š Health check
        run: |
          echo "ðŸ’š Checking staging health..."
          # curl -f https://staging.tuapp.com/health || exit 1
          echo "âœ… Staging deployment successful!"

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "### ðŸš€ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://staging.tuapp.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
